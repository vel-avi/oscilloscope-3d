<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>3D Oscilloscope Viewer (Single‚ÄëFile)</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#111826; --soft:#1b2537; --text:#e6edf7; --muted:#9fb0c7;
    --brand:#7dd3fc; --accent:#a78bfa; --danger:#fca5a5; --ok:#86efac;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b0f14 0%,#0a0d12 100%);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
  header{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;padding:.75rem 1rem;background:linear-gradient(180deg,#0d1220,#0a1020);border-bottom:1px solid #182035;position:sticky;top:0;z-index:10}
  header .title{font-weight:700;letter-spacing:.2px;margin-right:.5rem}
  header .spacer{flex:1}
  .panel{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  .panel > *{background:var(--panel);border:1px solid #1e2a43;color:var(--text);border-radius:14px;padding:.45rem .6rem}
  select,input[type="range"],input[type="number"]{appearance:none}
  input[type="file"]{border:none;padding:0;background:transparent}
  button{cursor:pointer;transition:.15s transform ease,.2s background-color ease}
  button:hover{transform:translateY(-1px)}
  button.primary{background:linear-gradient(180deg,#1e2b4a,#18243c);border-color:#2b3a5e}
  button.ghost{background:#0e1422;border-color:#1e2a43}
  button.danger{background:#2a1111;border-color:#4b1a1a}
  .hint{color:var(--muted);font-size:12px;margin-left:.25rem}
  #stage{position:relative}
  #stage, canvas{width:100%;height:100%}
  .foot{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.5rem 1rem;border-top:1px solid #182035;background:linear-gradient(180deg,#0a0f1b,#090e19)}
  .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .badge{padding:.25rem .5rem;border-radius:999px;background:#0f172a;border:1px solid #1f2a44;color:#9fb0c7;font-size:12px}
  a.download{color:var(--ok);text-decoration:none}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="title">üîä 3D Oscilloscope Viewer</div>
    <div class="panel">
      <label class="btn">
        <input id="file" type="file" accept="audio/*" />
      </label>
      <button id="play" class="primary">Play ‚ñ∂</button>
      <button id="pause" class="ghost">Pause ‚è∏</button>
      <select id="mode" title="Visualization mode">
        <option value="wave2d">Waveform (2D)</option>
        <option value="spec3d">Spectrum (3D Bars)</option>
        <option value="lissa2d">Lissajous (2D)</option>
        <option value="spiral3d">Spiral (3D Line)</option>
      </select>
      <label>FFT
        <input id="fft" type="number" min="32" max="32768" step="32" value="2048" style="width:5.5rem" />
      </label>
      <label> Smoothing
        <input id="smoothing" type="range" min="0" max="0.95" step="0.01" value="0.7" />
      </label>
      <label> Gain
        <input id="gain" type="range" min="0" max="4" step="0.01" value="1" />
      </label>
      <label> Line Width
        <input id="linewidth" type="range" min="1" max="8" step="1" value="2" />
      </label>
      <label> Color
        <input id="color" type="color" value="#7dd3fc" />
      </label>
      <button id="record" class="primary">Start Recording ‚è∫</button>
      <button id="stoprec" class="danger" disabled>Stop ‚èπ</button>
      <span id="dlwrap" class="hint"></span>
    </div>
    <div class="spacer"></div>
    <div class="hint">Load an audio file ‚Üí press Play. Modes change the look. You can record to WebM.</div>
  </header>

  <div id="stage"></div>

  <footer class="foot">
    <div class="row">
      <span class="badge">Audio: <span id="status">idle</span></span>
      <span class="badge">FPS: <span id="fps">0</span></span>
      <span class="badge">Vertices: <span id="verts">0</span></span>
    </div>
    <div class="row">
      <span class="hint">Made with Web Audio API + Three.js. Single‚Äëfile app.</span>
    </div>
  </footer>
</div>

<audio id="player" crossorigin="anonymous" style="display:none"></audio>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

const $ = (id)=>document.getElementById(id);
const ui = {
  file: $('file'), play: $('play'), pause: $('pause'), mode: $('mode'),
  fft: $('fft'), smoothing: $('smoothing'), gain: $('gain'), linewidth: $('linewidth'), color: $('color'),
  record: $('record'), stoprec: $('stoprec'), dlwrap: $('dlwrap'),
  status: $('status'), fps: $('fps'), verts: $('verts')
};

let actx, source, splitter, analyserL, analyserR, analyserMain, gainNode;
let dataTime, dataFreq, dataL, dataR;
const audioEl = $('player');

function ensureAudio(){
  if (actx) return;
  actx = new (window.AudioContext || window.webkitAudioContext)();
  source = actx.createMediaElementSource(audioEl);
  gainNode = actx.createGain();
  splitter = actx.createChannelSplitter(2);

  analyserMain = actx.createAnalyser();
  analyserL = actx.createAnalyser();
  analyserR = actx.createAnalyser();
  [analyserMain, analyserL, analyserR].forEach(a=>{
    a.fftSize = clampFFT(parseInt(ui.fft.value,10));
    a.smoothingTimeConstant = parseFloat(ui.smoothing.value);
  });

  source.connect(gainNode);
  gainNode.connect(splitter);
  splitter.connect(analyserL, 0);
  splitter.connect(analyserR, 1);
  gainNode.connect(analyserMain);
  gainNode.connect(actx.destination);
  allocateBuffers();
}

function allocateBuffers(){
  dataTime = new Float32Array(analyserMain.fftSize);
  dataFreq = new Uint8Array(analyserMain.frequencyBinCount);
  dataL = new Float32Array(analyserL.fftSize);
  dataR = new Float32Array(analyserR.fftSize);
}
function clampFFT(n){
  const allowed=[32,64,128,256,512,1024,2048,4096,8192,16384,32768];
  return allowed.includes(n)?n:2048;
}

const stage = $('stage');
const renderer = new THREE.WebGLRenderer({antialias:true,powerPreference:'high-performance'});
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.setSize(stage.clientWidth, stage.clientHeight);
stage.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x070a10);
const camera = new THREE.PerspectiveCamera(55, stage.clientWidth/stage.clientHeight, 0.1, 1000);
camera.position.set(0,1.25,4.5);
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.dampingFactor = .08; controls.maxDistance=25;

scene.add(new THREE.AmbientLight(0x8899aa,0.7));
const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(3,5,2); scene.add(dir);

const grid = new THREE.GridHelper(30, 30, 0x20304a, 0x101b2f);
grid.position.y = -1.25; scene.add(grid);

let visual = null;
const shared = { color: new THREE.Color(ui.color.value), lineWidth: parseInt(ui.linewidth.value,10) };

function makeWave2D(){
  const N = 2048;
  const geo = new THREE.BufferGeometry();
  const pos = new Float32Array(N*3);
  geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
  const mat = new THREE.LineBasicMaterial({color:shared.color, linewidth:1});
  const line = new THREE.Line(geo, mat);
  line.position.set(0,0,0);
  scene.add(line);
  return {
    object: line,
    dispose(){ scene.remove(line); geo.dispose(); mat.dispose(); },
    update(dt){
      analyserMain.getFloatTimeDomainData(dataTime);
      const L = dataTime.length;
      for(let i=0;i<N;i++){
        const t = i/(N-1);
        const idx = Math.floor(t*(L-1));
        const x = (t-0.5)*3.5;
        const y = dataTime[idx]*1.5;
        pos[i*3+0]=x; pos[i*3+1]=y; pos[i*3+2]=0;
      }
      geo.attributes.position.needsUpdate=true;
      mat.color.copy(shared.color);
    }
  };
}

function makeSpectrum3D(){
  const bins = 96;
  const w = 3.6, spacing = w/bins;
  const geo = new THREE.BoxGeometry(spacing*0.8, 1, spacing*0.8);
  const group = new THREE.Group();
  for(let i=0;i<bins;i++){
    const m = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({color:shared.color, metalness:.2, roughness:.35}));
    m.position.set((i/(bins-1)-.5)*w, 0, 0);
    group.add(m);
  }
  group.position.y = -0.2;
  scene.add(group);
  return {
    object: group,
    dispose(){ group.traverse(o=>o.isMesh&&o.geometry&&o.geometry.dispose()); group.traverse(o=>o.isMesh&&o.material&&o.material.dispose()); scene.remove(group); },
    update(dt){
      analyserMain.getByteFrequencyData(dataFreq);
      const L = dataFreq.length;
      group.children.forEach((m, i)=>{
        const t = i/(group.children.length-1);
        const idx = Math.floor(t*(L-1));
        const amp = dataFreq[idx]/255;
        m.scale.y = 0.2 + amp*3.2;
        m.position.y = m.scale.y/2 - 1.0;
        const hue = 0.55 + amp*0.35;
        m.material.color.setHSL(hue, 0.7, 0.6);
      });
    }
  };
}

function makeLissajous2D(){
  const N = 1500;
  const geo = new THREE.BufferGeometry();
  const pos = new Float32Array(N*3);
  geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
  const mat = new THREE.LineBasicMaterial({color:shared.color});
  const line = new THREE.Line(geo, mat);
  scene.add(line);
  return {
    object: line,
    dispose(){ scene.remove(line); geo.dispose(); mat.dispose(); },
    update(dt){
      analyserL.getFloatTimeDomainData(dataL);
      analyserR.getFloatTimeDomainData(dataR);
      const L = Math.min(dataL.length, dataR.length);
      for(let i=0;i<N;i++){
        const t = i/(N-1);
        const idx = Math.floor(t*(L-1));
        const x = dataL[idx]*1.8;
        const y = dataR[idx]*1.8;
        pos[i*3+0]=x; pos[i*3+1]=y; pos[i*3+2]=0;
      }
      geo.attributes.position.needsUpdate=true;
      mat.color.copy(shared.color);
    }
  };
}

function makeSpiral3D(){
  const SEG=1600;
  const geo = new THREE.BufferGeometry();
  const pos = new Float32Array(SEG*3);
  geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
  const mat = new THREE.LineBasicMaterial({color:shared.color});
  const line = new THREE.Line(geo, mat);
  scene.add(line);
  let z=0, dz=0.012, theta=0;
  return {
    object: line,
    dispose(){ scene.remove(line); geo.dispose(); mat.dispose(); },
    update(dt){
      analyserMain.getFloatTimeDomainData(dataTime);
      let sum=0; for(let i=0;i<dataTime.length;i++) sum += Math.abs(dataTime[i]);
      const amp = Math.min(1, sum/dataTime.length*2.6);
      theta += 0.1 + amp*0.2; z += dz;
      for(let i=SEG-1;i>0;i--){
        pos[i*3+0]=pos[(i-1)*3+0];
        pos[i*3+1]=pos[(i-1)*3+1];
        pos[i*3+2]=pos[(i-1)*3+2];
      }
      const r = 0.8 + amp*0.9;
      pos[0]=Math.cos(theta)*r;
      pos[1]=Math.sin(theta)*r*0.6;
      pos[2]=Math.sin(theta*0.23)*0.8;
      geo.attributes.position.needsUpdate=true;
      mat.color.copy(shared.color);
    }
  };
}

const factory = { wave2d: makeWave2D, spec3d: makeSpectrum3D, lissa2d: makeLissajous2D, spiral3d: makeSpiral3D };
function setMode(name){ if (visual) { visual.dispose(); visual = null; } visual = factory[name](); }

function onResize(){
  const w = stage.clientWidth, h = stage.clientHeight;
  renderer.setSize(w,h,false);
  camera.aspect = w/h; camera.updateProjectionMatrix();
}
window.addEventListener('resize', onResize);

let recorder=null, chunks=[];
function startRecording(){
  const stream = renderer.domElement.captureStream(60);
  recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
  chunks=[];
  recorder.ondataavailable = e=>{ if (e.data.size>0) chunks.push(e.data); };
  recorder.onstop = ()=>{
    const blob = new Blob(chunks, {type:'video/webm'});
    const url = URL.createObjectURL(blob);
    ui.dlwrap.innerHTML = `<a class="download" href="${url}" download="oscilloscope.webm">Download video</a>`;
  };
  recorder.start();
  ui.record.disabled=true; ui.stoprec.disabled=false;
}
function stopRecording(){
  if(recorder){ recorder.stop(); recorder=null; }
  ui.record.disabled=false; ui.stoprec.disabled=true;
}

ui.file.addEventListener('change', ()=>{
  const f = ui.file.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  audioEl.src = url;
  ui.status.textContent = `loaded: ${f.name}`;
});
ui.play.addEventListener('click', async ()=>{
  ensureAudio();
  try{ await actx.resume(); }catch(e){}
  if (!audioEl.src) { ui.status.textContent = 'please load an audio file'; return; }
  await audioEl.play();
  ui.status.textContent = 'playing';
});
ui.pause.addEventListener('click', ()=>{ audioEl.pause(); ui.status.textContent = 'paused'; });

ui.mode.addEventListener('change', ()=> setMode(ui.mode.value));
ui.color.addEventListener('input', ()=>{ shared.color.set(ui.color.value); });
ui.linewidth.addEventListener('input', ()=>{ shared.lineWidth = parseInt(ui.linewidth.value,10); });
ui.gain.addEventListener('input', ()=>{ ensureAudio(); gainNode.gain.value = parseFloat(ui.gain.value); });
ui.smoothing.addEventListener('input', ()=>{ [analyserMain, analyserL, analyserR].forEach(a=> a && (a.smoothingTimeConstant=parseFloat(ui.smoothing.value))); });
ui.fft.addEventListener('change', ()=>{
  const n = clampFFT(parseInt(ui.fft.value,10));
  [analyserMain, analyserL, analyserR].forEach(a=>{ if(!a) return; a.fftSize = n; });
  allocateBuffers();
});

ui.record.addEventListener('click', startRecording);
ui.stoprec.addEventListener('click', stopRecording);

let last=performance.now(), frames=0, fpsTime=0;
function tick(now){
  const dt=(now-last)/1000; last=now; frames++; fpsTime+=dt; if(fpsTime>0.5){ ui.fps.textContent = (frames/fpsTime).toFixed(0); frames=0; fpsTime=0; }
  if(visual){
    visual.update(dt);
    ui.verts.textContent = visual.object.geometry ? (visual.object.geometry.attributes.position?.count||0) : (visual.object.children?.length||0);
  }
  controls.update();
  renderer.render(scene,camera);
  requestAnimationFrame(tick);
}
onResize();
setMode('wave2d');
requestAnimationFrame(tick);
</script>
</body>
</html>
